<h2 class="py-5 text-center text-6xl">List of users</h2>

<div class="p-6">
  <!-- Add User Button -->
  <div
    (click)="toggleForm()"
    class="mb-4 flex max-w-fit cursor-pointer items-center justify-center gap-2 rounded px-4 py-2 text-bright underline"
  >
    <span>Add New User</span>
    <svg-icon
      [src]="'assets/icons/chevron-left.svg'"
      [svgClass]="
        'h-6 w-6 text-shade ' +
        (isFormVisible() ? 'rotate-90' : '-rotate-90') +
        ' stroke-[2] transition-transform'
      "
      [applyClass]="true"
    ></svg-icon>
  </div>

  <!-- Add User Form -->
  @if (isFormVisible()) {
    <form
      [formGroup]="userForm"
      (ngSubmit)="onSubmit()"
      class="mb-6 rounded-lg bg-primary p-6 shadow-lg"
    >
      <!-- Name Fields -->
      <div class="mb-4 flex gap-4">
        <div class="flex-1">
          <input
            type="text"
            formControlName="first_name"
            placeholder="First Name"
            pInputText
            class="w-full"
          />
          @if (
            userForm.get('first_name')?.touched &&
            userForm.get('first_name')?.invalid
          ) {
            <span class="mt-1 text-sm text-red-500"
              >First name is required</span
            >
          }
        </div>
        <div class="flex-1">
          <input
            type="text"
            formControlName="last_name"
            placeholder="Last Name"
            pInputText
            class="w-full"
          />
          @if (
            userForm.get('last_name')?.touched &&
            userForm.get('last_name')?.invalid
          ) {
            <span class="mt-1 text-sm text-red-500">Last name is required</span>
          }
        </div>
      </div>

      <div class="mb-4 flex gap-4">
        <!-- Email Field -->
        <div class="flex-1">
          <input
            type="email"
            formControlName="email"
            placeholder="Email"
            pInputText
            class="w-full"
          />
          @if (
            userForm.get('email')?.touched && userForm.get('email')?.invalid
          ) {
            <span class="mt-1 text-sm text-red-500"
              >Please enter a valid email</span
            >
          }
        </div>
        <!-- Date of Birth Field -->
        <div class="w-full flex-1">
          <p-datepicker
            formControlName="dob"
            placeholder="Date of Birth"
            [showIcon]="true"
            dateFormat="dd/mm/yy"
            class="w-full"
          ></p-datepicker>
          @if (userForm.get('dob')?.touched && userForm.get('dob')?.invalid) {
            <span class="mt-1 text-sm text-red-500"
              >Date of birth is required</span
            >
          }
        </div>
      </div>

      <!-- Interests Field -->
      <div class="mb-6">
        <input
          type="text"
          formControlName="interests"
          placeholder="Interests"
          pInputText
          class="w-full"
        />
      </div>

      <!-- Form Buttons -->
      <div class="flex gap-3">
        <button
          type="submit"
          [disabled]="!userForm.valid"
          class="rounded bg-accent px-6 py-2 text-bright transition-colors hover:bg-blue-600 disabled:cursor-not-allowed disabled:opacity-50"
        >
          Create
        </button>
        <button
          type="button"
          (click)="toggleForm()"
          class="rounded border border-accent bg-transparent px-6 py-2 text-bright transition-colors hover:bg-muted"
        >
          Cancel
        </button>
      </div>
    </form>
  }

  <!-- Users Table -->
  <div class="overflow-x-auto">
    <p-table
      [value]="users()"
      [tableStyle]="{ 'min-width': '50rem' }"
      editMode="row"
      dataKey="id"
    >
      <ng-template pTemplate="header">
        <tr>
          @for (header of tableHeaders; track $index) {
            <th>{{ header }}</th>
          }
        </tr>
      </ng-template>

      <ng-template
        pTemplate="body"
        let-user
        let-editing="editing"
        let-ri="rowIndex"
      >
        <tr [pEditableRow]="user">
          <td>{{ ri + 1 }}</td>
          <td>
            <p-cellEditor>
              <ng-template pTemplate="input">
                <input
                  pInputText
                  type="text"
                  [(ngModel)]="user.first_name"
                  [ngModelOptions]="{ standalone: true }"
                />
              </ng-template>
              <ng-template pTemplate="output">
                {{ user.first_name }}
              </ng-template>
            </p-cellEditor>
          </td>

          <td>
            <p-cellEditor>
              <ng-template pTemplate="input">
                <input
                  pInputText
                  type="text"
                  [(ngModel)]="user.last_name"
                  [ngModelOptions]="{ standalone: true }"
                />
              </ng-template>
              <ng-template pTemplate="output">
                {{ user.last_name }}
              </ng-template>
            </p-cellEditor>
          </td>

          <td>
            <p-cellEditor>
              <ng-template pTemplate="input">
                <input
                  pInputText
                  type="email"
                  [(ngModel)]="user.email"
                  [ngModelOptions]="{ standalone: true }"
                />
              </ng-template>
              <ng-template pTemplate="output">
                {{ user.email }}
              </ng-template>
            </p-cellEditor>
          </td>

          <td>
            <p-cellEditor>
              <ng-template pTemplate="input">
                <p-datepicker
                  [(ngModel)]="user.dob"
                  [ngModelOptions]="{ standalone: true }"
                  dateFormat="dd/mm/yy"
                  [showIcon]="true"
                ></p-datepicker>
              </ng-template>
              <ng-template pTemplate="output">
                {{ user.dob | formatDate }}
              </ng-template>
            </p-cellEditor>
          </td>

          <td>
            <p-cellEditor>
              <ng-template pTemplate="input">
                <input
                  pInputText
                  type="text"
                  [(ngModel)]="user.interests"
                  [ngModelOptions]="{ standalone: true }"
                />
              </ng-template>
              <ng-template pTemplate="output">
                {{ user.interests }}
              </ng-template>
            </p-cellEditor>
          </td>

          <td>
            @if (!editing) {
              <button
                pButton
                pRipple
                type="button"
                pInitEditableRow
                icon="pi pi-pencil"
                (click)="onRowEditInit(user)"
                class="p-button-rounded p-button-text"
              >
                Update
              </button>
              <button
                pButton
                pRipple
                type="button"
                icon="pi pi-trash"
                (click)="deleteUser(user.id, $event)"
                class="p-button-rounded p-button-text p-button-danger"
              >
                Delete
              </button>
            }
            @if (editing) {
              <button
                pButton
                pRipple
                type="button"
                pSaveEditableRow
                icon="pi pi-check"
                (click)="onRowEditSave(user)"
                class="p-button-rounded p-button-text p-button-success"
              >
                Save
              </button>
              <button
                pButton
                pRipple
                type="button"
                pCancelEditableRow
                icon="pi pi-times"
                (click)="onRowEditCancel(user)"
                class="p-button-rounded p-button-text p-button-danger"
              >
                Cancel
              </button>
            }
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center">No users found</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
